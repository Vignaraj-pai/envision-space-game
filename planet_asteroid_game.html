<!DOCTYPE html>
<html lang="en">

<head>

    <title>Document</title>
    <meta charset="UTF-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Galactic Wide Web</title>
    <script src="//cdn.jsdelivr.net/npm/phaser@3.11.0/dist/phaser.js"></script>
    <style type="text/css">
        body {
            margin: 0;
        }
    </style>
</head>

<body>
    <script type="text/javascript">
        var config = {
            type: Phaser.AUTO,
            width: 1300,
            height: 700,
            physics: {
                default: "arcade",
                arcade: {
                    gravity: {
                        y: 0
                    },
                    debug: false,
                },
            },
            scene: {
                preload: preload,
                create: create,
                update: update,
            },
        };

        var player;
        var cursors;
        var asteroids;
        var planet1;
        var planet2;
        var bullet;
        var explosion;
        var lives = 5;
        var points = 0;
        var pointsText;
        var livesText;
        var numOfPlanets = 1;
        var gameOver = false;
        var bulletTime = 0;

        var game = new Phaser.Game(config);

        function preload() {
            this.load.image("starfield", "assets/starfield.png");
            this.load.image("boundary", "assets/boundary.png");
            this.load.image("player", "assets/player.png", {
                frameWidth: 32,
                frameHeight: 48,
            });
            this.load.image("asteroid", "assets/asteroid.png", {
                frameWidth: 32,
                frameHeight: 48,
            });
            this.load.image("planet1", "assets/planet_1.png", {
                frameWidth: 32,
                frameHeight: 48,
            });
            this.load.image("planet2", "assets/planet_2.png", {
                frameWidth: 32,
                frameHeight: 48,
            });
            this.load.spritesheet("explode", "assets/explode.png", {
                frameWidth: 128,
                frameHeight: 128,
            });
            this.load.image("bullet", "assets/bullet.png", {
                frameWidth: 32,
                frameHeight: 48,
            });
        }

        function create() {
            starfield = this.add.tileSprite(0, 0, 4000, 1400, "starfield");
            boundary = this.physics.add.sprite(0, 450, "boundary").setScale(2.23).setImmovable(true)
            player = this.physics.add.sprite(400, 500, "player");
            player.setCollideWorldBounds(true);

            const collisionHandler = (boundary, obj) => {
                obj.setBounce(1)
            }

            this.physics.add.collider(boundary, player, collisionHandler);
            // this.physics.add.collider(bullet, asteroids);
            planet1 = this.physics.add.sprite(30, 30, "planet1");
            planet2 = this.physics.add.sprite(700, 15, "planet2");

            livesText = this.add.text(16, 16, "Lives left: " + lives, {
                fontSize: "32px",
                fill: "#fff",
            });



            pointsText = this.add.text(16, 50, "Points: " + points, {
                fontSize: "32px",
                fill: "#fff",
            });

            cursors = this.input.keyboard.createCursorKeys();

            asteroids = this.physics.add.group({
                maxSize: 30
            });

            // might have to change 30 to 29
            for (let y = 0; y < 30; y++) {
                asteroids.create(Phaser.Math.Between(0, 1300), Phaser.Math.Between(0, 350), 'asteroid')
            }

            asteroids.getChildren().forEach(function(asteroid) {
                this.physics.add.collider(boundary, asteroid, collisionHandler);
                asteroid.setCollideWorldBounds(true);
                asteroid.setBounce(1);
                asteroid.setVelocityX(Phaser.Math.Between(-100, 100));
                asteroid.setVelocityY(Phaser.Math.Between(-100, 100));
            }, this);

            planet1.setScale(3);
            planet1.setBounce(1);
            //planet1.setCircle(true);

            planet2.setScale(4);
            planet2.setBounce(1);
            //planet2.setCircle(true);

            planet1.setCollideWorldBounds(true);
            planet2.setCollideWorldBounds(true);

            //planet1.disableBody(true, true);
            //planet2.disableBody(true, true);

            explosions = this.physics.add.group({
                max: 0
            });

            this.anims.create({
                key: 'explode',
                frames: this.anims.generateFrameNumbers('explode', {
                    start: 0,
                    end: 15
                }),
                frameRate: 24,
                repeat: 0,
                hideOnComplete: true
            })


            nextLevel();
        }

        function update() {
            if (gameOver) {
                livesText.setText(
                    "Lives left: " +
                    lives +
                    ". Thankyou for playing :) Your score is: " + points
                );
                this.scene.pause();
                return;
            }

            starfield.tilePositionY -= 2;

            if (cursors.left.isDown) {
                player.setVelocityX(-180);
            } else if (cursors.right.isDown) {
                player.setVelocityX(180);
            } else if (cursors.up.isDown) {
                player.setVelocityY(-180);
            } else if (cursors.down.isDown) {
                player.setVelocityY(+180);
            } else if (cursors.space.isDown) {
                // fire the bullet
                if (this.time.now > bulletTime) {
                    bullet = this.physics.add.sprite(player.x, player.y+8, "bullet");
                    bullet.setVelocityY(-500);
                    bulletTime = this.time.now + 200;

                }
            } else {
                player.setVelocityY(0);
                player.setVelocityX(0);
            }
            this.physics.add.overlap(player, planet1, playerHitPlanet, null, this);
            this.physics.add.overlap(player, planet2, playerHitPlanet, null, this);
            //this.physics.add.overlap(bullet, asteroids, bulletHitAsteroid, null, this);
        }



        const bulletHitAsteroid = (bullet, asteroid) => {
            // explosion = new Explosion(this, bullet.x, bullet.y)
            asteroid.disableBody(true, true);
            points = points + 5;
            pointsText.setText("Points: " + points);
        }

        function playerHitPlanet(ply, planet) {
            explosion = new Explosion(this, player.x, player.y)
            player.disableBody(false, true);
            lives -= 1;
            livesText.setText("Lives left: " + lives);
            numOfPlanets += 1;

            if (lives <= 0) {
                gameOver = true;
            }

            this.time.delayedCall(1000, nextLevel, [], this);
            this.time.delayedCall(1000, respawnPlayer, [], this);
            //ply.enable = true;

            // we should make it such that the extra planets are created in the nextLevel() section and not in the loading section.
            // only problem now is making main character disappear and come back.
        }

        function respawnPlayer() {
            player.enableBody(true, 400, 500, true, true);
        }

        function nextLevel() {
            if (numOfPlanets >= 1) {
                planet1.x = 30;
                planet1.y = 30;
                var velocityCoin = Phaser.Math.FloatBetween(0, 1);
                planet1.setVelocityX(
                    Phaser.Math.Between(
                        velocityCoin > 0.5 ? 100 : -300,
                        velocityCoin > 0.5 ? 300 : -100
                    )
                );
                velocityCoin = Phaser.Math.FloatBetween(0, 1);
                planet1.setVelocityY(
                    Phaser.Math.Between(
                        velocityCoin > 0.5 ? 100 : -300,
                        velocityCoin > 0.5 ? 300 : -100
                    )
                );
            }
            if (numOfPlanets >= 2) {
                planet2.x = 700;
                planet2.y = 15;
                var velocityCoin = Phaser.Math.FloatBetween(0, 1);
                planet2.setVelocityX(
                    Phaser.Math.Between(
                        velocityCoin > 0.5 ? 100 : -300,
                        velocityCoin > 0.5 ? 300 : -100
                    )
                );
                velocityCoin = Phaser.Math.FloatBetween(0, 1);
                planet2.setVelocityY(
                    Phaser.Math.Between(
                        velocityCoin > 0.5 ? 100 : -300,
                        velocityCoin > 0.5 ? 300 : -100
                    )
                );
            }
        }

        class Explosion extends Phaser.Physics.Arcade.Sprite {
            constructor(scene, x, y, texture) {
                super(scene, x, y, texture = 'explode');
                scene.add.existing(this);
                this.play('explode');
            }
        }
    </script>
</body>

</html>